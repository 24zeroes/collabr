<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>collabr - DUAL SHADOW METHOD</title>    
    <script src="../lib/diff.js"></script>
</head>
<body>
    <h3>Document</h3>
    <textarea id=textarea name=article>&lt;p>Empty.&lt;/p></textarea>
    <div id=div style="white-space: pre-wrap" hidden><p>Empty.</p></div>
</body>
    <script>
        var clientText = "", shadowCopy = "";

        // Visual
        let textarea = document.getElementById("textarea");
        let div = document.getElementById("div");
        textarea.hidden = true;
        div.hidden = false;
        div.contentEditable = "true";
        div.oninput = (e) => {
            textarea.value = div.innerHTML;
        };

        // Typing trigger
        var typingTimer;                //timer identifier
        var doneTypingInterval = 500;  //time in ms, 5 second for example
        

        //on keyup, start the countdown
        div.onkeyup = (e) => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(doneTyping, doneTypingInterval);
        };

        //on keydown, clear the countdown 
        div.onkeydown = (e) => {
            clearTimeout(typingTimer);
        };

        //user is "finished typing," do something
        function doneTyping () {
            clientText = textarea.value;
            getUpdatedClientText(clientText);
        }

        // Document init from server
        fetch("/api/document").then(function(response) {
            return response.json();
        }).then(function(data) {
            div.innerHTML = data.content;
            textarea.value = data.content;
            shadowCopy = data.content;
            clientText = data.content;
        }).catch(function() {
            console.log("Error fetching /api/document");
        });

        var dmp = new diff_match_patch();


        function getUpdatedClientText(source){
            // On client
            let diff = dmp.diff_main(shadowCopy, source, true);

            if (diff.length > 2) {
                dmp.diff_cleanupSemantic(diff);
            }
            const patch_list = dmp.patch_make(shadowCopy, source, diff);
            
            shadowCopy = source;
            
            const patch_text = dmp.patch_toText(patch_list);

            const result = "";
            // Document init from server
            fetch("/api/document/save", 
                { 
                    method: 'POST', 
                    body: patch_text
                })
            .then(function(response) {
                return response.json();
            }).then(function(data) {
                console.log(data.patches);
                const patches = dmp.patch_fromText(data.patches);
                const shadowCopyResults = dmp.patch_apply(patches, shadowCopy);
                shadowCopy = shadowCopyResults[0];

                const clientTextResults = dmp.patch_apply(patches, clientText);
                clientText = clientTextResults[0];
                div.innerHTML = clientText;
                textarea.value = clientText;
            }).catch(function(ex) {
                console.log("Error fetching /api/document/save + " + ex);
            });
        }

        function getUpdatedText(source, dest){
            // On client
            let diff = dmp.diff_main(shadowCopy, source, true);

            if (diff.length > 2) {
                dmp.diff_cleanupSemantic(diff);
            }
            const patch_list = dmp.patch_make(shadowCopy, source, diff);
            
            shadowCopy = source;
            
            // On server
            const results = dmp.patch_apply(patch_list, dest);

            return results[0];
        }

        function log(){
            console.log("ClientText = " + clientText);
            console.log("CommonShadow = " + shadowCopy);
            console.log("ServerText = " + serverText);
        }

    </script>
</html>